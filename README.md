# Thinkpad P71 hacks

A collection of hacks to make my P71 more usefull.

Let me know if you get your fingerprint sensor working.

## Setup

My particular P71 has the 17" 4k 3840x2160 display and an nvidia GPU.

I've set performance mode to disable the onboard intel gpu which causes issues with brigtness 
keys that are fixed below.

I'm currently using ubuntu 17.10 with ubuntu-studio (a loaded xfce variant) with the nvidia 
priorietary drivers.

Defaults use xrandr and screenlock scrambles the order of metamodes.  It's 
most useful then to take over control of display toggles and use nvidia-settings -a 
CurrentMetaMode to directly toggle modes.

## brightness.sh

Allows toggling brighness of displays that do not support xbacklight via xrandr.

Assumes external display is on DP-3.1.

***USED IN***
*Keycodes Ctrl+XF86MonBrightness[Up|Down] (xfce)*
```
/home/rferguson/code/scripts/brightness.sh -inc 5
/home/rferguson/code/scripts/brightness.sh -dec 5
```
Tied to Ctrl+XF86MonBrightness[Down|Up] to toggle external display brightness.

***Note***

The P71 backlight keys are broken when in xorg when the intel GPU is disabled. This is fixed by 
tying the keycodes to xbacklight.

*Keycodes XF86MonBrightness[Up|Down] (xfce)*
```
/usr/bin/xbacklight -inc 10
/usr/bin/xbacklight -dec 10
```

## nv-metamode-toggle.py

Allows toggling nvidia metamodes as defined in xorg.conf.

Usage:

```
nv-metamode-toggle.py       # Prints index: mode list.
nv-metamode-toggle.py indx  # Sets metamode to index.
nv-metamode-toggle.py n     # Toggles metamode to current + 1
```

***USED IN***

*/etc/lightdm/lightdm.conf*

```ini
[LightDM]
display-setup-script=/home/rferguson/code/scripts/nv-metamode-toggle.py 1
xserver-config=/etc/X11/xorg.conf

[Seat:*]
display-setup-script=/home/rferguson/code/scripts/nv-metamode-toggle.py 1
xserver-config=/etc/X11/xorg.conf

```

*/etc/lightdm/lightdm-gtk-greeter.conf*
```ini
[greeter]
font-name = Noto Sans 12
-indicators = 
screensaver-timeout = 18
hide-user-image = true
position = 30%,center 49%,center
user-background = false
display-setup-script=/home/rferguson/code/scripts/nv-metamode-toggle.py 1
xserver-config=/etc/X11/xorg.conf
```

*Keycode XF86Display (xfce)*
```
sh -c "/home/rferguson/code/scripts/nv-metamode-toggle.py n"
```


## grub toggle for reasonable console size

Note that fb resolutions for console don't work the same when not using uefi boot.

*/etc/defaults/grub*
```
GRUB_DEFAULT=0
GRUB_TIMEOUT_MODE=countdown
GRUB_TIMEOUT=20
GRUB_DISTRIBUTOR=`lsb_release -i -s 2> /dev/null || echo Debian`
GRUB_CMDLINE_LINUX_DEFAULT="nvme_core.default_ps_max_latency_us=0 nvidea-drm.modeset=1"
GRUB_CMDLINE_LINUX=""
GRUB_GFXMODE=1920x1200
```

*/etc/modprobe.d/nvidia-installer-disable-nouveau.conf*
```
# generated by nvidia-installer
blacklist nouveau
options nouveau modeset=0
```
*initramfs-tools/modules*
```
# List of modules that you want to include in your initramfs.
# They will be loaded at boot time in the order below.
#
# Syntax:  module_name [args ...]
#
# You must run update-initramfs(8) to effect this change.
#
# Examples:
#
# raid1
# sd_mod
nvidia
nvidia_modeset
nvidia_uvm
nvidia_drm
```

## xorg.conf

Note: If you find settings you prefer either via xrandr or nvidia-setting, you can find the 
metamode via nvidia-settings -q CurrentMetaMode and add that to the semicolon delimited metamodes
 string in xorg.conf.

```
# Current xorg.conf Ubuntu 17.10 ubuntu studio / xfce on a P71 with 3840x2160 HD internal LCD on 
# DFP-4 and Acer CB280HK on DFP-3.1 also 3860x2160.
#
# Viewport settings allows smaller laptop display to render objects at nearly identical size.

Section "ServerLayout"
    Identifier     "Default Layout"
    Screen      0  "Screen0" 0 0
    InputDevice    "Keyboard0" "CoreKeyboard"
    InputDevice    "Mouse0" "CorePointer"
    Option         "Xinerama" "0"
EndSection

Section "Files"
EndSection

Section "InputDevice"
    # generated from default
    Identifier     "Mouse0"
    Driver         "mouse"
    Option         "Protocol" "auto"
    Option         "Device" "/dev/psaux"
    Option         "Emulate3Buttons" "no"
    Option         "ZAxisMapping" "4 5"
EndSection

Section "InputDevice"
    # generated from default
    Identifier     "Keyboard0"
    Driver         "kbd"
EndSection

Section "Monitor"
    # HorizSync source: edid, VertRefresh source: edid
    Identifier     "Monitor0"
    VendorName     "Unknown"
    ModelName      "Panasonic"
    HorizSync       129.0 - 138.0
    VertRefresh     58.0 - 62.0
    Option         "DPMS"
EndSection

Section "Monitor"
    Identifier     "Monitor1"
    VendorName     "Unknown"
    ModelName      "Acer CB280HK"
    Option         "DPMS"
EndSection

Section "Device"
    Identifier     "Device0"
    Driver         "nvidia"
    VendorName     "NVIDIA Corporation"
    BoardName      "Quadro M620"
EndSection

Section "Screen"
    Identifier     "Screen0"
    Device         "Device0"
    Monitor        "Monitor0"
    DefaultDepth    24
    Option         "DPI" "144 x 144"
    Option         "Stereo" "0"
    Option         "nvidiaXineramaInfoOrder" "DFP-4,DFP"
    Option         "metamodes" "DFP-4: 3840x2160_60 @2560x2160 +0+0 {ViewPortIn=2560x1440, ViewPortOut=3840x2160+0+0}, DFP: NULL;DFP-4: 3840x2160_60 @2560x1441 +0+0 {ViewPortIn=2560x1440, ViewPortOut=3840x2160+0+0}, DFP: NULL; DFP-4: 3840x2160_60 @2560x1441 +0+0 {ViewPortIn=2560x1440, ViewPortOut=3840x2160+0+0}, DFP: 3840x2160_60 @3840x2160 +2560+0 {ViewPortIn=3840x2160, ViewPortOut=3840x2160+0+0}; DFP-4: 3840x2160_60 @2560x2160 +0+0 {ViewPortIn=2560x1440, ViewPortOut=3840x2160+0+0}, DFP: 3840x2160_60 @3840x2160 +2560+0 {ViewPortIn=3840x2160, ViewPortOut=3840x2160+0+0}"
    Option         "SLI" "Off"
    Option         "MultiGPU" "Off"
    Option         "BaseMosaic" "Off"
    Option         "ModeDebug" "True"
    Option         "IncludeImplicitMetaModes" "Off"
    SubSection     "Display"
        Depth       24
    EndSubSection
EndSection

Section "Extensions"
    Option         "Composite" "Enable"
EndSection
```

## Using nvidia without disabling the intel gpu

If you do not want to be locked into using the nvidia GPU or want to use the intel for maybe some
alternate screen, you can back out the performance mode setting in bios and try to merge in some
of the work in the xorg.conf files found in the prime-select repo.
  
https://github.com/wildtruc/nvidia-prime-select

This might be something I look into later to give myself better battery life on the road.

